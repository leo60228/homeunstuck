<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div id="main">
        <header>Header</header>
        <div id="container">
            <div id="slide">
                <div id="command"></div>
                <div id="content">
                    <span>
                        <br>
                        <div id="emptyHolder"></div>
                        <br>
                        <br>
                        <div class="spoiler closed" id="spoilerHolder">
                            <div style="text-align: center;" id="buttonHolder">
                                <input type="button" id="myButton" value="Close Skorpelog"
                                    style="padding: 1px 6px; border: 1px solid black;">
                                <!-- <button class="changeOpen">This is a button</button> -->
                            </div>
                            <div id="chatlogHolder">
                                <div style="text-align: left;" id="chatlog">
                                    <!-- 
                                    --<span style="color: #a00078;">grandioseSaturation [GS]</span> began trolling <span
                                        style="color: #510049;">unclaspedKahuna [UK]</span>
                                    <br>
                                    <span style="color: #a00078;">GS: Hey.<br>GS: So, I believe you told me that
                                        everything is going to get demolished, correct?</span>
                                    <br>
                                    <span style="color: #510049;">UK: >([w#at]</span>
                                    <br>
                                    <span style="color: #510049;">
                                        UK: >([omfg you wise ass minilungs]
                                        UK: >([you is the ONLY one wit# the real deal know #ow on t#is front and you
                                        t#ought im still ac#in on about small potato fry pseudofeels]
                                        UK: >([badly rendered gamez w#ere you flap ur arms in a barren void wit#
                                        politically undertoned furnis#ings is my fav kinda game but you know t#e big
                                        deal is startin to be pus#ed out rig#t from under us]
                                    </span> -->
                                    <br>
                                    <span style="color: #004696;">WA: Are you alive-?</span>
                                    <br>
                                    <span style="color: #004696;">WA: Oh-</span>
                                    <br>
                                    <span style="color: #004696;">WA: Alright- I guess I'll just go lay down or
                                        something-</span>
                                    <br>
                                    <span id="wtf" style="color: #004696;">
                                        WA: Man-
                                        <br>
                                        WA: I know you're there-
                                        <br>
                                        WA: You like literally never go anywhere-
                                    </span>
                                    <span>This is some bullshit</span>
                                </div>
                            </div>
                        </div>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script src="jquery.js"></script>
    <script>
        //MAIN SCRIPT
        const chatlog = document.getElementById('content');
        recurseContent(chatlog);

        //DOM TRAVERSAL
        function recurseContent(element) {
            //BASE CASE ONE: a simple span tag
            if (element.nodeName === 'SPAN' && element.children.length === 0) { //span with no children - easy to check!
                element.textContent = fixQuirk(element.textContent);
                return;
            }

            //BASE CASE TWO: an element that's not a span but still has no children
            if (!element.hasChildNodes()) {
                return;
            }

            //otherwise, traverse the children
            const numChildren = element.children.length;

            for (let i = 0; i < numChildren; i++) {
                let currentNode = element.children[i];
                //check for the one irritating case where a single span has a chunk of br tags
                //because people don't know how to act
                if (isMultiLinePesterLog(currentNode)) {
                    const splitUpLines = currentNode.innerHTML.split("<br>").map(str => str = str.trim());
                    currentNode.innerHTML = '';
                    splitUpLines.forEach(line => {
                        let newSpan = document.createElement('span');
                        newSpan.textContent = fixQuirk(line);
                        currentNode.appendChild(newSpan);
                        currentNode.appendChild(document.createElement('br'));
                    });
                }
                else {
                    //otherwise, just keep on recursin'
                    recurseContent(element.children[i]);
                }
            }
        }

        //returns TRUE if this particular node is a type of pesterlog span which contains multiple lines of text separated with br
        //returns FALSE if there are deeper levels than just text & br
        function isMultiLinePesterLog(node) {
            if (node.nodeName !== 'SPAN' || node.children.length === 0) {
                return false;
            }

            let numChildren = node.children.length;

            for (let i = 0; i < numChildren; i++) {
                if (node.children[i].nodeName !== 'BR') {
                    return false;
                }
            }
            return true;
        }

        //MUTATION CALLBACKS
        function mutationCallback(mutationList, observer) {
            //we only want to bother replacing the text if the chatlog is being opened
            //we also only want to do this once
            var completedSubstitution = false;
            mutationList.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class' && !completedSubstitution) {
                    mutation.target.classList.forEach(function (value, index) {
                        console.log(mutation);
                        if (value === "open" && !completedSubstitution) {
                            console.log("Firing!");
                            //CODE GOES HERE
                            observer.disconnect(); //after we've substituted once, kill the observer
                            completedSubstitution = true;
                        }
                    });
                }
            });
        }

        //DETERMINE AND FIX QUIRK
        //EXPECTS a source string
        //RETURNS a string which has been stripped of quirks
        function fixQuirk(str) {
            console.log("str");
            let result = str;
            let pesterLogID = str.slice(0,3);
            console.log("Looking for " + peseterLogID);

            return result;
        }

        //FIXES FOR QUIRKS
        function fixMurrit(node) {
            //oh hooray!  let's deal with the utter bullshit that is these spans and how they (don't) work
            let allText = node.innerText.split('UK: ');
            allText = allText.map(string => {
                string = string
                    .replace(/#/g, 'h')
                    .replace(/\>\(\[/, 'UK: ')
                    .replace(/\]$/, '');
                console.log(string);
            });

            /*         let newText = node.innerText
                        .replace(/#/g, 'h')
                        .replace(/UK: \>\(\[/, 'UK: ')
                        .replace(/\]$/, '');
                    let newTextNode = document.createTextNode(newText); */
            /*    node.innerHTML = '';
               node.appendChild(newTextNode); */
        }

        function fixLaivan(textNode) {

            //allText = allText.replace(/-/g, '');
        }
    </script>

</body>

</html>