<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div id="main">
        <header>Header</header>
        <div id="container">
            <div id="slide">
                <div id="command"></div>
                <div id="content">
                    <span>
                        <br>
                        <!--                         <img src=""> -->
                        <br>
                        <br>
                        <div class="spoiler closed">
                            <div style="text-align: center;">
                                <button class="changeOpen">This is a button</button>
                            </div>
                            <div>
                                <div style="text-align: left;" id="chatlog">

                                    --<span style="color: #a00078;">grandioseSaturation [GS]</span> began trolling <span
                                        style="color: #510049;">unclaspedKahuna [UK]</span>
                                    <br>
                                    <span style="color: #a00078;">GS: Hey.<br>GS: So, I believe you told me that
                                        everything is going to get demolished, correct?</span>
                                    <br>
                                    <span style="color: #510049;">UK: >([w#at]</span>
                                    <br>
                                    <span style="color: #510049;">
                                        UK: omfg you wise ass minilungs]
                                        UK: >([you is the ONLY one with the real deal know how on this front and you
                                        thought im still achin on about small potato fry pseudofeels]
                                        UK: >([badly rendered gamez where you flap ur arms in a barren void with
                                        politically undertoned furnishings is my fav kinda game but you know the big
                                        deal is startin to be pushed out right from under us
                                    </span>
                                </div>
                            </div>
                        </div>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script src="jquery.js"></script>
    <script>
        $(".changeOpen").on("click", function () {
            console.log("Clicked!");

            if ($('.spoiler').hasClass('open')) {
                console.log("Closing!");
                $('.spoiler').removeClass('open');
                $('.spoiler').addClass('closed');
            }
            else {
                console.log("Opening!");
                console.log("Remove old");
                $('.spoiler').removeClass('closed');
                console.log("Add new");
                $('.spoiler').addClass('open');

            }
        });

        //MAIN CODE:
        //1) Look for a block of 'spoiler' text (which is where quirks will be hiding in pesterlogs)
        //2) If said block exists, set up a mutation listener to check when the 'open' class gets added, as that's when we'll care about changing the text
        var parentDOM = document.getElementById('content');
        var targetNode = parentDOM.getElementsByClassName('spoiler')[0]; //there should only be one target Node on the page at a time

        //if we found a spoiler block, set a mutation listener
        if (targetNode) {
            //set up the options for mutation - we're only looking at this spoiler block where the chat log lives
            var observerOptions = {
                childList: false,
                attributes: true,
                subtree: false
            }

            var observer = new MutationObserver(mutationCallback);
            observer.observe(targetNode, observerOptions);
        }

        //MUTATION CALLBACKS
        function mutationCallback(mutationList, observer) {
            //we only want to bother replacing the text if the chatlog is being opened
            //we also only want to do this once
            var completedSubstitution = false;
            mutationList.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class' && !completedSubstitution) {
                    mutation.target.classList.forEach(function (value, index) {
                        console.log(mutation);
                        if (value === "open" && !completedSubstitution) {
                            console.log("Firing!");
                            vastErrorFix();
                            observer.disconnect(); //after we've substituted once, kill the observer
                            completedSubstitution = true;
                        }
                    });
                }
            });
        }

        //DETERMINE QUIRK
        function vastErrorFix() {
            const allSpans = document.querySelectorAll('span'); //REFACTOR THIS

            for (let node of allSpans) {
                switch (node.innerText.slice(0, 3)) {
                    case "UK:": fixMurrit(node);
                        break;
                    default:
                        break;
                }
            }
        }

        //FIXES FOR QUIRKS
        function fixMurrit(node) {
            //oh hooray!  let's deal with the utter bullshit that is these spans and how they (don't) work
            console.log("Fuck you Murrit");
            let allText = node.innerText.split('UK: ');
            allText = allText.map(string => {
                string = string
                    .replace(/#/g, 'h')
                    .replace(/\>\(\[/, 'UK: ')
                    .replace(/\]$/, '');
                console.log(string);
            });

    /*         let newText = node.innerText
                .replace(/#/g, 'h')
                .replace(/UK: \>\(\[/, 'UK: ')
                .replace(/\]$/, '');
            let newTextNode = document.createTextNode(newText); */
            node.innerHTML = '';
            node.appendChild(newTextNode);
        }

    </script>

</body>

</html>